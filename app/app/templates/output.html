 <!-- output.html -->

 <!DOCTYPE html>
 <html lang="en">
 
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Final Grade Output</title>
     <style>
         * {
             margin: 0;
             padding: 0;
             box-sizing: border-box;
             font-family: 'Arial', sans-serif;
         }
 
         body {
             background-color: #f7f9fc;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             min-height: 100vh;
             padding: 20px;
             width: 100vw;
         }
 
         .container {
             background: white;
             padding: 40px;
             width: 90%;
             max-width: 1200px;
             border-radius: 12px;
             box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
             text-align: center;
             margin-bottom: 30px;
         }
 
         .grade-summary {
             display: flex;
             justify-content: center;
             flex-wrap: wrap;
             gap: 20px;
             margin-bottom: 20px;
         }
 
         .card {
             background: white;
             padding: 20px;
             border-radius: 10px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
             text-align: center;
             width: 200px;
             font-size: 18px;
             font-weight: bold;
         }
 
         .question-card {
             background: white;
             padding: 20px;
             border-radius: 10px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
             text-align: center;
             width: 200px;
             font-size: 18px;
             font-weight: bold;
             transition: all 0.3s ease;
         }
 
         .question-card:hover {
             transform: translateY(-5px);
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
         }
 
         .feedback-container {
             margin-top: 30px;
             text-align: left;
             padding: 20px;
             background: #f8f9fa;
             border-radius: 10px;
             display: none;
         }
 
         .buttons {
             margin-top: 20px;
             display: flex;
             justify-content: center;
             gap: 20px;
         }
 
         .btn {
             padding: 14px 24px;
             border: none;
             border-radius: 8px;
             cursor: pointer;
             font-size: 18px;
             font-weight: bold;
             transition: all 0.3s ease;
         }
 
         .btn:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
         }
 
         .btn-generate {
             background: #4a6cf7;
             color: white;
         }
 
         .btn-download {
             background: #28a745;
             color: white;
             display: none;
         }
 
         .btn-startover {
             background: #212529;
             color: white;
         }
 
         .success-score {
             color: #28a745;
         }
 
         .warning-score {
             color: #ffc107;
         }
 
         .danger-score {
             color: #dc3545;
         }
 
         .debug-info {
             margin-top: 20px;
             padding: 10px;
             background-color: #f8f9fa;
             border: 1px solid #ddd;
             border-radius: 4px;
             text-align: left;
             font-family: monospace;
             font-size: 14px;
             display: none;
         }
     </style>
 </head>
 
 <body>
     <div class="container">
         <h2>ðŸ“Š Final Grade Report</h2>
         <br>
         <div class="grade-summary">
             <div class="card">Total Questions: <span id="total-questions">Loading...</span></div>
             <div class="card">Total Score: <span id="total-score">Loading...</span></div>
         </div>
         <div class="grade-summary" id="questions-container">
             <!-- Question Score Cards Will Be Generated Here -->
             <div id="loading-questions" class="card">Loading question scores...</div>
         </div>
         
         <div class="feedback-container" id="feedback-container">
             <h3>Detailed Feedback:</h3>
             <div id="detailed-feedback">Loading detailed feedback...</div>
         </div>
         
         <div class="buttons">
             <button class="btn btn-generate" id="generate-btn" onclick="generateReport()">Generate Report</button>
             <button class="btn btn-download" id="download-btn">Download Report</button>
             <a href="{% url 'dashboard' %}"><button class="btn btn-startover">Start Over</button></a>
         </div>
 
         <!-- Debug information - hidden by default -->
         <div class="debug-info" id="debug-info">
             <h4>Debug Information</h4>
             <div id="debug-output"></div>
         </div>
     </div>
 
     <!-- Load the evaluation data from the session -->
     {% if evaluation_json %}
     <script id="evaluation-data" type="application/json">{{ evaluation_json|safe }}</script>
     {% endif %}
 
     <script>
         // Debug logging function
         function debugLog(message, data) {
             console.log(message, data);
             
             const debugOutput = document.getElementById('debug-output');
             if (debugOutput) {
                 const entry = document.createElement('div');
                 entry.style.marginBottom = '10px';
                 
                 let content = `<strong>${message}</strong>`;
                 if (data !== undefined) {
                     if (typeof data === 'object') {
                         try {
                             content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                         } catch (e) {
                             content += `<pre>${String(data)}</pre>`;
                         }
                     } else {
                         content += `<pre>${data}</pre>`;
                     }
                 }
                 
                 entry.innerHTML = content;
                 debugOutput.appendChild(entry);
             }
         }
         
         // Enable debug mode with URL parameter ?debug=true
         const urlParams = new URLSearchParams(window.location.search);
         const debugMode = urlParams.get('debug') === 'true';
         if (debugMode) {
             document.getElementById('debug-info').style.display = 'block';
             debugLog('Debug mode enabled');
         }
 
         // Get the score class based on the score value
         function getScoreClass(score) {
             if (score >= 80) return 'success-score';
             if (score >= 60) return 'warning-score';
             return 'danger-score';
         }
 
         document.addEventListener("DOMContentLoaded", function() {
             debugLog('DOM Content Loaded');
             
             // Try to load evaluation data
             let evaluationData = null;
             const evaluationElement = document.getElementById('evaluation-data');
             
             if (evaluationElement) {
                 try {
                     evaluationData = JSON.parse(evaluationElement.textContent);
                     debugLog('Loaded evaluation data:', evaluationData);
                 } catch (e) {
                     debugLog('Error parsing evaluation data:', e.message);
                 }
             } else {
                 debugLog('Evaluation data element not found');
             }
             
             // Check if we have evaluation data from the server
             if (!evaluationData) {
                 // Try to retrieve from session storage as fallback
                 try {
                     const storedData = sessionStorage.getItem('evaluationData');
                     if (storedData) {
                         evaluationData = JSON.parse(storedData);
                         debugLog('Loaded evaluation data from session storage:', evaluationData);
                     }
                 } catch (e) {
                     debugLog('Error loading from session storage:', e.message);
                 }
             }
             
             // If we have data, display it
             if (evaluationData) {
                 displayEvaluationResults(evaluationData);
             } else {
                 debugLog('No evaluation data available');
                 // Show a message
                 document.getElementById('total-questions').textContent = 'No data';
                 document.getElementById('total-score').textContent = 'No data';
                 document.getElementById('loading-questions').textContent = 'No evaluation data available';
             }
         });
 
         function displayEvaluationResults(data) {
            debugLog('Displaying evaluation results');
            
            // Update the score summary
            document.getElementById('total-questions').textContent = data.evaluations ? data.evaluations.length : 'N/A';
            
            // Calculate overall score if it exists, or use total_score if provided
            let totalScore = 0;
            let questionCount = 0;
            
            if (data.evaluations && data.evaluations.length > 0) {
                data.evaluations.forEach(q => {
                    // Use score field first, then similarity_percentage as fallback
                    totalScore += (q.score || q.similarity_percentage || 0);
                    questionCount++;
                });
                
                // Use calculated average or take total_score if provided
                const averageScore = data.total_score || (questionCount > 0 ? Math.round(totalScore / questionCount) : 0);
                document.getElementById('total-score').textContent = `${averageScore}/100`;
                document.getElementById('total-score').className = getScoreClass(averageScore);
                
                // Clear loading message
                document.getElementById('questions-container').innerHTML = '';
                
                // Generate question cards
                data.evaluations.forEach(question => {
                    let card = document.createElement("div");
                    card.classList.add("question-card");
                    
                    // Use score field first, then similarity_percentage as fallback
                    const score = question.score || question.similarity_percentage || 0;
                    
                    card.innerHTML = `Q${question.question_no}: <span class="${getScoreClass(score)}">${score}/100</span>`;
                    card.dataset.questionNo = question.question_no;
                    card.dataset.feedback = question.feedback || 'No feedback provided';
                    
                    // Add click event to show feedback
                    card.addEventListener('click', function() {
                        showFeedback(this.dataset.questionNo, this.dataset.feedback);
                    });
                    
                    document.getElementById('questions-container').appendChild(card);
                });
                
                // Show the detailed feedback if available
                if (data.overall_feedback) {
                    document.getElementById('feedback-container').style.display = 'block';
                    document.getElementById('detailed-feedback').textContent = data.overall_feedback;
                }
                
                // Enable the download button
                document.getElementById('generate-btn').style.display = 'none';
                document.getElementById('download-btn').style.display = 'inline-block';
            } else if (data.total_score !== undefined) {
                // Direct total score format
                document.getElementById('total-score').textContent = `${data.total_score}/100`;
                document.getElementById('total-score').className = getScoreClass(data.total_score);
                
                // Display message
                if (data.overall_feedback) {
                    const messageCard = document.createElement("div");
                    messageCard.classList.add("card");
                    messageCard.style.width = "100%";
                    messageCard.textContent = data.overall_feedback;
                    document.getElementById('questions-container').innerHTML = '';
                    document.getElementById('questions-container').appendChild(messageCard);
                }
                
                // Enable the download button
                document.getElementById('generate-btn').style.display = 'none';
                document.getElementById('download-btn').style.display = 'inline-block';
            } else {
                debugLog('Invalid evaluation data format:', data);
                document.getElementById('total-questions').textContent = 'Invalid';
                document.getElementById('total-score').textContent = 'Invalid';
                document.getElementById('loading-questions').textContent = 'Invalid evaluation data format';
            }
        } 
         function showFeedback(questionNo, feedback) {
             document.getElementById('feedback-container').style.display = 'block';
             document.getElementById('detailed-feedback').innerHTML = `
                 <h4>Question ${questionNo} Feedback:</h4>
                 <p>${feedback}</p>
             `;
             
             // Scroll to the feedback
             document.getElementById('feedback-container').scrollIntoView({ behavior: 'smooth' });
         }
 
         function generateReport() {
             debugLog('Generate report clicked');
             
             let btn = document.querySelector('.btn-generate');
             btn.innerHTML = "Generating...";
             
             // Simulate report generation 
             setTimeout(() => {
                 btn.style.display = "none";
                 document.getElementById("download-btn").style.display = "inline-block";
                 
                 // Show feedback container
                 document.getElementById('feedback-container').style.display = 'block';
                 document.getElementById('detailed-feedback').innerHTML = `
                     <p>Report generated successfully. Click "Download Report" to save a PDF copy.</p>
                 `;
             }, 1500);
         }
 
         // Download button click handler
         document.getElementById('download-btn').addEventListener('click', function() {
             debugLog('Download button clicked');
             
             // Create a printable version
             const printWindow = window.open('', '_blank');
             printWindow.document.write(`
                 <html>
                 <head>
                     <title>Exam Grading Report</title>
                     <style>
                         body { font-family: Arial; padding: 20px; }
                         h1 { text-align: center; }
                         .summary { margin: 20px 0; }
                         .question { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
                     </style>
                 </head>
                 <body>
                     <h1>Exam Grading Report</h1>
                     <div class="summary">
                         <p><strong>Total Questions:</strong> ${document.getElementById('total-questions').textContent}</p>
                         <p><strong>Overall Score:</strong> ${document.getElementById('total-score').textContent}</p>
                     </div>
                     <h2>Question Scores:</h2>
                     <div class="questions">
                         ${Array.from(document.querySelectorAll('.question-card')).map(card => `
                             <div class="question">
                                 <p><strong>${card.textContent}</strong></p>
                                 <p>Feedback: ${card.dataset.feedback}</p>
                             </div>
                         `).join('')}
                     </div>
                 </body>
                 </html>
             `);
             
             printWindow.document.close();
             printWindow.print();
         });
     </script>
 </body>
 
 </html>