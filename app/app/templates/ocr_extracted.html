<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Extracted Answers</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f7f9fc; 
        }
        .container { 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 20px; 
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .card-body {
            padding: 20px;
        }
        .card-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: space-between;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }
        .key {
            color: #d73a49; /* red */
        }
        .string {
            color: #032f62; /* blue */
        }
        .number {
            color: #005cc5; /* darker blue */
        }
        .boolean {
            color: #005cc5; /* darker blue */
        }
        .null {
            color: #005cc5; /* darker blue */
        }
        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: .2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        #evaluation_results {
            margin-top: 30px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OCR Extracted Answers</h1>
        
        <div class="card">
            <div class="card-body">
                {% if extracted_data %}
                    <div>
                        {% for question in extracted_data %}
                        <div class="card mb-3">
                            <div class="card-header">
                                Question {{ question.question_no }}
                            </div>
                            <div class="card-body">
                                <h5>Question:</h5>
                                <p>{{ question.question_statement }}</p>
                                
                                <h5>Student's Answer:</h5>
                                <p>{{ question.complete_answer }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <h3>JSON Data</h3>
                    <div id="raw-json-debug" class="debug-info">
                        <h5>Raw extracted_data_json (first 500 chars):</h5>
                        <pre id="raw-json-content">{{ extracted_data_json|truncatechars:500 }}</pre>
                    </div>
                    
                    <pre id="json-display">Error parsing JSON data</pre>
                    
                    <!-- Add hidden input for storing the extracted data -->
                    <input type="hidden" id="extracted_data_json" value="{{ extracted_data_json|escapejs }}">

                    <!-- Error alert container -->
                    <div id="error-alert" class="alert alert-danger" style="display:none;"></div>
                    
                    <!-- Success alert container -->
                    <div id="success-alert" class="alert alert-success" style="display:none;"></div>

                    <!-- Evaluation results will be displayed here -->
                    <div id="evaluation_results" class="mt-4">
                        {% if evaluation_json %}
                        <h2>LLM Evaluation</h2>
                        <pre id="eval-display">{{ evaluation_json }}</pre>
                        {% endif %}
                    </div>

                    <!-- Debug information -->
                    <div class="debug-info">
                        <h4>Debug Information</h4>
                        <div id="debug-output"></div>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 20px;">
                        <p>No extracted data available.</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="card-footer">
                <a href="{% url 'grading' %}" class="btn btn-secondary">Back</a>
                {% if extracted_data %}
                <button id="proceedButton" class="btn btn-primary">Proceed with Grading</button>
                {% else %}
                <a href="{% url 'output' %}" class="btn btn-primary">Proceed</a>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Debugging function to log to UI with comprehensive error handling
        function debugLog(message, data) {
            const debugOutput = document.getElementById('debug-output');
            if (debugOutput) {
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '10px';
                
                let content = `<strong>${message}</strong>`;
                if (data !== undefined) {
                    try {
                        // Comprehensive data handling
                        if (typeof data === 'object') {
                            content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                        } else if (typeof data === 'string') {
                            // Special handling for potentially problematic strings
                            const sanitizedData = data
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#39;');
                            content += `<pre>${sanitizedData}</pre>`;
                        } else {
                            content += `<pre>${String(data)}</pre>`;
                        }
                    } catch (e) {
                        content += `<pre>Unable to stringify data: ${e.message}</pre>`;
                    }
                }
                
                logEntry.innerHTML = content;
                debugOutput.appendChild(logEntry);
            }
            console.log(message, data);
        }
    
        // Syntax highlighting function for JSON
        function syntaxHighlight(json) {
            if (typeof json !== 'string') {
                try {
                    json = JSON.stringify(json, undefined, 2);
                } catch (e) {
                    debugLog("Error stringifying JSON:", e.message);
                    return String(json);
                }
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'number';
                if (/^"/.test(match)) {
                    cls = /:$/.test(match) ? 'key' : 'string';
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    
        // Comprehensive JSON parsing function with special handling for Unicode escapes
        function parseExtractedData() {
            const extractedDataInput = document.getElementById('extracted_data_json');
            if (extractedDataInput) {
                try {
                    // Get the raw input string
                    let jsonString = extractedDataInput.value;
                    debugLog("Raw input value (first 100 chars):", jsonString.substring(0, 100));
                    
                    // Special handling for Django's escaped Unicode in JSON
                    // This is the key part that was missing before
                    try {
                        // First, handle the specific encoding pattern from Django
                        // Convert \u0022 to " and \u0027 to '
                        let decodedString = jsonString
                            .replace(/\\u0022/g, '"')
                            .replace(/\\u0027/g, "'")
                            .replace(/\\u002D/g, "-")
                            .replace(/\\u003D/g, "=")
                            .replace(/\\u005C/g, "\\")
                            .replace(/\\u002B/g, "+");
                        
                        // Attempt to parse the decoded string directly
                        let parsedData = JSON.parse(decodedString);
                        debugLog("Successfully parsed data using Unicode decoding:", {
                            questionCount: parsedData.extracted_questions ? parsedData.extracted_questions.length : 0
                        });
                        
                        // Return the parsed data
                        return parsedData;
                    } catch (decodeError) {
                        debugLog("Unicode decoding parse failed:", decodeError);
                        // Continue to other strategies if this fails
                    }
                    
                    // Multiple parsing strategies as fallbacks
                    const parsingStrategies = [
                        // Strategy 1: Direct JSON parse
                        () => {
                            return JSON.parse(jsonString);
                        },
                        
                        // Strategy 2: Replace quotes and then parse
                        () => {
                            // Replace single quotes with double quotes
                            let cleanedString = jsonString.replace(/'/g, '"');
                            return JSON.parse(cleanedString);
                        },
                        
                        // Strategy 3: Manual JSON object construction (last resort)
                        () => {
                            // Extract questions using regex
                            const questionsRegex = /"question_no"[^{]*"question_statement"[^{]*"complete_answer"[^}]*/g;
                            const matches = jsonString.match(questionsRegex);
                            
                            if (!matches) throw new Error("No questions found in JSON");
                            
                            // Build questions array
                            const questions = matches.map(match => {
                                const questionNo = match.match(/"question_no"\s*:\s*"([^"]*)"/)[1];
                                const statement = match.match(/"question_statement"\s*:\s*"([^"]*)"/)[1];
                                const answer = match.match(/"complete_answer"\s*:\s*"([^"]*)"/)[1];
                                
                                return {
                                    question_no: questionNo,
                                    question_statement: statement,
                                    complete_answer: answer
                                };
                            });
                            
                            return { extracted_questions: questions };
                        }
                    ];

                    // Try each parsing strategy
                    let parsedData = null;
                    let successfulStrategy = -1;

                    for (let i = 0; i < parsingStrategies.length; i++) {
                        try {
                            parsedData = parsingStrategies[i]();
                            successfulStrategy = i;
                            break;
                        } catch (strategyError) {
                            debugLog(`Parsing strategy ${i} failed:`, strategyError);
                        }
                    }

                    // Validate parsed data
                    if (!parsedData) {
                        throw new Error('All parsing strategies failed');
                    }

                    // Ensure we have extracted_questions
                    const extractedQuestions = parsedData.extracted_questions || 
                                               parsedData.extractedQuestions || 
                                               (Array.isArray(parsedData) ? parsedData : null);

                    if (!extractedQuestions || !Array.isArray(extractedQuestions)) {
                        throw new Error('Invalid data structure: extracted_questions not found or not an array');
                    }

                    debugLog(`Successfully parsed data using strategy ${successfulStrategy}:`, {
                        questionCount: extractedQuestions.length,
                        firstQuestion: extractedQuestions[0]
                    });

                    return { extracted_questions: extractedQuestions };

                } catch (error) {
                    debugLog('Comprehensive parsing error:', {
                        errorMessage: error.message,
                        errorStack: error.stack
                    });
                    
                    // Show error in UI
                    const errorAlert = document.getElementById('error-alert');
                    if (errorAlert) {
                        errorAlert.textContent = `Fatal error parsing exam data: ${error.message}. Please contact support with the debug information.`;
                        errorAlert.style.display = 'block';
                    }
                    
                    return null;
                }
            }
            
            debugLog('No extracted data input found');
            return null;
        }
    
        // CSRF token retrieval function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Show status message function
        function showStatus(message, isError = false) {
            const statusEl = isError 
                ? document.getElementById('error-alert')
                : document.getElementById('success-alert');
                
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
                
                // Auto-hide success messages after 5 seconds
                if (!isError) {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            }
        }
    
        // Exam Grading Process Handler
        document.addEventListener('DOMContentLoaded', function() {
            debugLog("DOM Content Loaded");
            
            // Format the JSON display
            const extractedDataInput = document.getElementById('extracted_data_json');
            const jsonDisplay = document.getElementById('json-display');
            
            if (extractedDataInput && jsonDisplay) {
                try {
                    const rawJsonValue = extractedDataInput.value;
                    const parsedData = parseExtractedData();
                    
                    if (parsedData) {
                        // Syntax highlight the parsed data
                        jsonDisplay.innerHTML = syntaxHighlight(parsedData);
                    } else {
                        jsonDisplay.textContent = 'Unable to parse JSON data';
                    }
                } catch (e) {
                    debugLog('Error processing JSON display:', e);
                    jsonDisplay.textContent = `Error: ${e.message}`;
                }
            }
    
            const proceedButton = document.querySelector('#proceedButton');
            
            if (proceedButton) {
                proceedButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    debugLog("Proceed with Grading button clicked");
                    
                    // Hide any previous alerts
                    const errorAlert = document.getElementById('error-alert');
                    const successAlert = document.getElementById('success-alert');
                    if (errorAlert) errorAlert.style.display = 'none';
                    if (successAlert) successAlert.style.display = 'none';
                    
                    // Show button loading state
                    proceedButton.disabled = true;
                    proceedButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    
                    // Parse extracted data
                    const extractedData = parseExtractedData();
                    
                    if (extractedData && extractedData.extracted_questions) {
                        // Send data to server
                        fetch('/grade-exam/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                extracted_data: extractedData.extracted_questions
                            })
                        })
                        .then(response => {
                            debugLog("Server response status:", response.status);
                            
                            if (!response.ok) {
                                return response.text().then(text => {
                                    debugLog("Error response text:", text);
                                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            debugLog("Grading response received:", data);
    
                            if (data.status === 'success') {
                                // Show success message
                                showStatus('Grading successful! Redirecting to results...', false);
                                
                                // Redirect to output page after a short delay
                                setTimeout(() => {
                                    window.location.href = '/output/';
                                }, 1500);
                            } else {
                                throw new Error(data.error || 'Unknown grading error');
                            }
                        })
                        .catch(error => {
                            debugLog('Grading process error:', error);
                            
                            // Show error in UI
                            showStatus(`Grading error: ${error.message}`, true);
                        })
                        .finally(() => {
                            // Reset button state
                            proceedButton.disabled = false;
                            proceedButton.innerHTML = 'Proceed with Grading';
                        });
                    } else {
                        debugLog('No valid extracted data found');
                        
                        // Show error in UI
                        showStatus('Unable to parse exam data. Please try again.', true);
                        
                        // Reset button state
                        proceedButton.disabled = false;
                        proceedButton.innerHTML = 'Proceed with Grading';
                    }
                });
            }
        });
    </script>
</body>
</html>